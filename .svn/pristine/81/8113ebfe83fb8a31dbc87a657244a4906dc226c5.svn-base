package com.softserve.edu.manager;

import java.util.Date;
import java.util.List;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.softserve.edu.dao.CompetenceDao;
import com.softserve.edu.dao.GroupDao;
import com.softserve.edu.entity.Competence;
import com.softserve.edu.entity.Group;
import com.softserve.edu.entity.User;
import com.softserve.edu.exception.GroupManagerException;

@Service("groupManager")
public class GroupManagerImplementation implements GroupManager {

	@Autowired
	GroupDao groupDao;
	@Autowired
	CompetenceDao competenceDao;

	private static final Logger LOGGER = Logger
			.getLogger(GroupManagerImplementation.class);

	@Override
	@Transactional
	public List<Group> inFuture() {
		return groupDao.inFuture();

	}

	@Override
	@Transactional
	public List<Group> inFuture(Long competenceId) {
		return groupDao.inFuture(competenceId);
	}

	@Override
	@Transactional
	public List<Group> findByCompetence(Long competenceId, boolean onlyOpened) {

		return groupDao.findByCompetence(competenceId, onlyOpened);
	}

	@Override
	@Transactional
	public List<Group> findByCompetenceUuid(String competenceUuid,
			boolean onlyOpened) {

		return groupDao.findByCompetenceUuid(competenceUuid, onlyOpened);
	}

	@Override
	@Transactional
	public Long create(String name, Date startDate, Date endDate,
			Long competenceId) throws GroupManagerException {

		Competence competence = competenceDao.findById(competenceId);

		Group group = new Group();
		group.setName(name);
		group.setOpened(startDate);
		group.setClosed(endDate);
		group.setCompetence(competence);

		try {
			groupDao.save(group);
		} catch (Exception e) {
			LOGGER.error("cannot save group", e);
			throw new GroupManagerException("cannot save group", e);
		}
		return group.getId();
	}

	@Override
	@Transactional
	public void modify(final Long groupId, final String name, final Date start,
			final Date end, final Long competenceId)
			throws GroupManagerException {

		Competence competence = competenceDao.findById(competenceId);
		Group group = groupDao.findById(groupId);
		group.setName(name);
		group.setOpened(start);
		group.setClosed(end);
		group.setCompetence(competence);
		try {
			groupDao.update(group);
		} catch (Exception e) {
			LOGGER.error("cannot update group", e);
			throw new GroupManagerException("cannot update group", e);
		}
	}

	@Override
	@Transactional
	public void create(String name, Date startDate, Date endDate,
			String competenceUuid) throws GroupManagerException {

		Competence competence = competenceDao.findByUuid(competenceUuid);
		System.out.println(competence);
		Group group = new Group();
		group.setName(name);
		group.setOpened(startDate);
		group.setClosed(endDate);
		group.setCompetence(competence);

		try {
			groupDao.update(group);
		} catch (Exception e) {
			LOGGER.error("cannot update group", e);
			throw new GroupManagerException("cannot update group", e);
		}
	}

	@Override
	@Transactional
	public void addUser(Long userId, Long groupId) throws GroupManagerException {
		try {
			groupDao.addUser(userId, groupId);
		} catch (Exception e) {
			LOGGER.error("cannot add user to group", e);
			throw new GroupManagerException("cannot add user to group", e);
		}
	}

	@Override
	@Transactional
	public void addUser(String userUuid, String groupUuid)
			throws GroupManagerException {
		try {
			groupDao.addUser(userUuid, groupUuid);
		} catch (Exception e) {
			LOGGER.error("cannot add user to group", e);
			throw new GroupManagerException("cannot add user to group", e);
		}
	}

	@Override
	@Transactional
	public List<User> users(Long groupId) {

		return groupDao.userList(groupId);
	}

	@Override
	@Transactional
	public List<User> findUsersByGroupUuid(String groupUuid) {

		return groupDao.findUsersByGroupUuid(groupUuid);
	}

	@Override
	@Transactional
	public void deleteById(Long groupId) throws GroupManagerException {
		Group toDelete = groupDao.findById(groupId);
		try {
			groupDao.delete(toDelete);
		} catch (Exception e) {
			LOGGER.error("cannot delete group", e);
			throw new GroupManagerException("cannot delete group", e);
		}

	}
}
